<!DOCTYPE html>
<html lang="ZH-CN">
<head>
    <meta charset="utf-8">
    <script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
    <title>title</title>
    <style>
    .booth {
        width:400px;
        background:#ccc;
        border: 10px solid #ddd;
        margin: 0 auto;
    }
    </style>
</head>
<body>
    <video id="video"></video>
    <button id="btn" onclick="start()">start</button>
    <button id="stopbtn" onclick="stop()">stop</button>
    <canvas id="canvas"></canvas>
    <img id="img" width="320" height="240"/>
</body>
<script>
    let convas = document.querySelector("#canvas")
    let video = document.querySelector("#video")
    let img = document.querySelector("#img")
    let btn = document.querySelector("button")
    let context = canvas.getContext('2d')
    let width = 320
    let height = 0
    let streaming = false
    var interveal
    // let img = new Image()
    navigator.mediaDevices.getUserMedia({video: true, audio: false}).then(stream => {
        video.srcObject = stream
        video.play()
        interveal = setInterval(snapAndUpload, 500)
    })
    function start() {
        interveal = setInterval(snapAndUpload, 500)
    }
    function stop() {
        clearInterval(interveal)
    }
    function snapAndUpload() {
        var file = takecapture()
        var formData = new FormData()
        formData.append('data', file)
        $.ajax({
            url: 'http://localhost:8080/face/detect',
            data: formData,
            type: 'POST',
            contentType: false,
            processData: false,
            success: function (response) {
                img.src = "data:image/png;base64," + response
            },
            error: function (response) {
                console.log(response)
            }
        })
    }
    function takecapture() {
        if (streaming) {
            context.drawImage(video, 0, 0, 320, 240)
            return DataURL2Blob(canvas.toDataURL('img/png'), 'png')
        }
    }

    function DataURL2Blob (dataURL, type){
        var bytes = window.atob(dataURL.split(",")[1])
        var ab = new ArrayBuffer(bytes.length)
        var ia = new Uint8Array(ab)
        for (var i = 0; i < bytes.length; i++) {
            ia[i] = bytes.charCodeAt(i)
        }
        return new Blob([ab], {type : 'image/' + type})
    }
    // btn.addEventListener('click', snapAndUpload, false) // 按钮点击事件

    // 监听视频流就位事件,即视频可以播放了
    video.addEventListener('canplay', function (ev) {
        if (!streaming) {
            height = video.videoHeight / (video.videoWidth / width)
            console.log(height)
            video.setAttribute('width', width)
            video.setAttribute('height', height)
            canvas.setAttribute('width', width)
            canvas.setAttribute('height', height)
            streaming = true
        }
    }, false)
</script>
</html>